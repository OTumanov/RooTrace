# План рефакторинга: mcp-handler.ts

## Текущее состояние
- **Размер**: ~2147 строк
- **Проблемы**: Монолитный класс с множественными ответственностями
- **Сложность**: Очень высокая - содержит MCP сервер, обработку инструментов, валидацию, мониторинг

## Цели рефакторинга
1. Разделить на модули по функциональности
2. Улучшить тестируемость
3. Упростить добавление новых инструментов
4. Изолировать зависимости

## Структура модулей после рефакторинга

### 1. `mcp-handler/core/` - Основная логика MCP сервера
**Файлы:**
- `mcp-server.ts` - Основной класс `RooTraceMCPHandler`
- `mcp-server-factory.ts` - Фабрика для создания сервера
- `mcp-request-handler.ts` - Базовый обработчик запросов

**Ответственность:**
- Инициализация MCP сервера
- Обработка базовых запросов (initialize, list_tools, list_resources)
- Управление жизненным циклом сервера

### 2. `mcp-handler/tools/` - Обработка инструментов
**Файлы:**
- `tool-registry.ts` - Регистрация всех инструментов
- `tool-handler.ts` - Базовый обработчик инструментов
- `tools/` - Обработчики конкретных инструментов:
  - `read-runtime-logs-tool.ts`
  - `clear-logs-tool.ts`
  - `get-debug-status-tool.ts`
  - `clear-session-tool.ts`
  - `inject-probes-tool.ts`
  - `inject-multiple-probes-tool.ts`
  - `show-user-instructions-tool.ts`
  - `read-file-tool.ts`
  - `get-problems-tool.ts`
  - `load-rule-tool.ts`

**Ответственность:**
- Обработка вызовов инструментов
- Валидация параметров
- Выполнение логики инструментов
- Формирование ответов

**Интерфейс ToolHandler:**
```typescript
export interface ToolHandler {
  /**
   * Обрабатывает вызов инструмента
   * @param args Параметры инструмента (из MCP запроса)
   * @param context Контекст выполнения (sessionId, workspaceRoot и т.д.)
   * @returns Результат выполнения инструмента в формате MCP
   */
  handle(
    args: Record<string, any>,
    context: ToolHandlerContext
  ): Promise<CallToolResult>;
  
  /**
   * Валидирует параметры инструмента перед выполнением
   * @param args Параметры для валидации
   * @returns Результат валидации
   */
  validate(args: Record<string, any>): ValidationResult;
  
  /**
   * Имя инструмента
   */
  readonly name: string;
  
  /**
   * Описание инструмента
   */
  readonly description: string;
}

export interface ToolHandlerContext {
  sessionId: string;
  workspaceRoot: string;
  // Дополнительный контекст при необходимости
}

export interface ValidationResult {
  valid: boolean;
  errors?: string[];
}
```

### 3. `mcp-handler/validation/` - Валидация и безопасность
**Файлы:**
- `tool-validator.ts` - Валидация параметров инструментов
- `file-safety-checker.ts` - Проверки безопасности файлов
  - `git-commit-checker.ts` - Проверка git commit перед редактированием
  - `python-file-checker.ts` - Проверка запрета для Python файлов
  - `backup-checker.ts` - Проверка наличия backup
- `approval-checker.ts` - Проверка разрешений пользователя

**Ответственность:**
- Валидация входных параметров
- Проверки безопасности
- Проверка разрешений пользователя

**Интерфейс ToolValidator:**
```typescript
export interface ToolValidator {
  /**
   * Валидирует параметры инструмента
   * @param toolName Имя инструмента
   * @param args Параметры для валидации
   * @returns Результат валидации
   */
  validate(toolName: string, args: Record<string, any>): ValidationResult;
}

export interface FileSafetyChecker {
  /**
   * Проверяет безопасность редактирования файла
   * @param filePath Путь к файлу
   * @returns Результат проверки
   */
  checkSafety(filePath: string): Promise<SafetyCheckResult>;
}

export interface SafetyCheckResult {
  allowed: boolean;
  error?: string;
  requiredAction?: string;
}
```

### 4. `mcp-handler/monitoring/` - Мониторинг и контекст
**Файлы:**
- `context-monitor-adapter.ts` - Адаптер для ContextMonitor
- `anomaly-detector-adapter.ts` - Адаптер для AnomalyDetector
- `session-tracker.ts` - Отслеживание сессий

**Ответственность:**
- Интеграция с мониторингом контекста
- Отслеживание аномалий
- Управление сессиями

### 5. `mcp-handler/resources/` - Обработка ресурсов
**Файлы:**
- `resource-handler.ts` - Базовый обработчик ресурсов
- `resources/` - Обработчики конкретных ресурсов:
  - `logs-resource.ts` - `roo-trace://logs`
  - `status-resource.ts` - `roo-trace://status`
  - `rules-resource.ts` - `roo-trace://rules`
  - `rule-resource.ts` - `roo-trace://rule/{name}`

**Ответственность:**
- Обработка запросов ресурсов
- Формирование содержимого ресурсов

### 6. `mcp-handler/integration/` - Интеграции
**Файлы:**
- `code-injector-adapter.ts` - Адаптер для code-injector
- `log-storage-adapter.ts` - Адаптер для SharedLogStorage
- `rules-loader-adapter.ts` - Адаптер для RulesLoader
- `server-tester.ts` - Тестирование сервера (`testServerWriteRead()`)

**Ответственность:**
- Интеграция с другими модулями
- Адаптеры для упрощения зависимостей

### 7. `mcp-handler/utils/` - Специфичные утилиты
**Файлы:**
- `file-scanner.ts` - Поиск файлов (`findFilesWithProbes()`)
- `tool-name-normalizer.ts` - Нормализация имен инструментов

**Ответственность:**
- Специфичные для MCP handler утилиты

**Примечание:** 
- ⚠️ **НЕ дублировать общие утилиты!** Использовать из `src/utils/`:
  - `normalizeFilePath()` → `utils/file-path-utils.ts`
  - `getWorkspaceRoot()` → `utils/workspace-utils.ts`
  - `findGitRoot()` → `utils/git-utils.ts`

### 8. `mcp-handler/retry/` - Retry механизмы
**Файлы:**
- `retry-handler.ts` - Базовый retry механизм
- `probe-injection-retry.ts` - Retry для инъекции проб (`injectProbeWithRetry()`)
- `error-classifier.ts` - Классификация ошибок (`isTemporaryError()`)

**Ответственность:**
- Retry логика для временных ошибок
- Классификация ошибок

### 9. `mcp-handler/logging/` - Логирование
**Файлы:**
- `mcp-logger.ts` - Логирование MCP запросов/ответов
  - `logMCPRequest()`
  - `logMCPResponse()`
  - `logMCPError()`

**Ответственность:**
- Логирование всех MCP операций
- Отслеживание производительности

### 10. `mcp-handler/types.ts` - Типы и интерфейсы
**Файлы:**
- `types.ts` - Все интерфейсы и типы
- `tool-schemas.ts` - JSON схемы для инструментов

**Ответственность:**
- Определение типов для всех модулей
- JSON схемы для валидации

## ⚠️ ВАЖНО: Использование общих утилит

**НЕ создавать дублирующиеся утилиты!** Использовать общие утилиты из `src/utils/`:

- ✅ `getWorkspaceRoot()` → `utils/workspace-utils.ts`
- ✅ `normalizeFilePath()` → `utils/file-path-utils.ts`
- ✅ `findGitRoot()` → `utils/git-utils.ts`

**Импорт:**
```typescript
import { 
  getWorkspaceRoot, 
  normalizeFilePath, 
  findGitRoot 
} from '../utils';
```

---

## Этапы рефакторинга

### Этап 1: Подготовка (1 день)
1. Создать структуру директорий `src/mcp-handler/`
2. Определить интерфейсы между модулями (см. детализацию выше)
3. Написать план миграции (см. `00-migration-strategy.md`)

### Этап 2: Извлечение типов (0.5 дня) ✅ Частично выполнено
1. ✅ Создать `types.ts` с всеми интерфейсами
2. ✅ Создать `tool-schemas.ts` с JSON схемами
3. Обновить импорты в основном файле
4. Добавить детализацию интерфейсов (см. выше)

### Этап 3: Извлечение специфичных утилит (0.5 дня)
1. Вынести `tool-name-normalizer.ts` (нормализация имен инструментов)
2. Вынести `file-scanner.ts` (поиск файлов с пробами)
3. Протестировать

**Примечание:** Общие утилиты уже в `src/utils/` - использовать оттуда!

### Этап 4: Извлечение валидации (2 дня)
1. Создать интерфейс `ToolValidator`
2. Вынести `git-commit-checker.ts`
3. Вынести `python-file-checker.ts`
4. Вынести `backup-checker.ts`
5. Вынести `approval-checker.ts`
6. Создать `file-safety-checker.ts` как композицию
7. Протестировать

### Этап 5: Извлечение инструментов (3-4 дня)
1. Создать интерфейс `ToolHandler`
2. Вынести каждый инструмент в отдельный файл
3. Создать `tool-registry.ts` для регистрации
4. Обновить обработку `CallToolRequestSchema`
5. Протестировать каждый инструмент

### Этап 6: Извлечение ресурсов (1 день)
1. Создать интерфейс `ResourceHandler`
2. Вынести обработчики ресурсов
3. Обновить обработку `ReadResourceRequestSchema`
4. Протестировать

### Этап 7: Извлечение интеграций (1 день)
1. Вынести адаптеры для других модулей
2. Вынести `server-tester.ts`
3. Протестировать

### Этап 8: Извлечение retry механизмов (1 день)
1. Вынести `retry-handler.ts`
2. Вынести `probe-injection-retry.ts`
3. Вынести `error-classifier.ts`
4. Протестировать

### Этап 9: Извлечение мониторинга (1 день)
1. Вынести адаптеры для мониторинга
2. Вынести `session-tracker.ts`
3. Протестировать

### Этап 10: Извлечение логирования (0.5 дня)
1. Вынести `mcp-logger.ts`
2. Протестировать

### Этап 11: Извлечение core логики (2 дня)
1. Рефакторинг основного класса
2. Вынести обработку базовых запросов
3. Обновить зависимости
4. Протестировать интеграцию

### Этап 12: Рефакторинг основного файла (1 день)
1. Оставить только координацию
2. Удалить дублирующийся код
3. Обновить документацию

### Этап 13: Тестирование и оптимизация (4-5 дней)

#### Unit-тесты для каждого модуля:
- [ ] `read-runtime-logs-tool.test.ts` - тесты инструмента чтения логов
- [ ] `inject-probes-tool.test.ts` - тесты инструмента инъекции проб
- [ ] `clear-session-tool.test.ts` - тесты инструмента очистки сессии
- [ ] `get-debug-status-tool.test.ts` - тесты инструмента статуса
- [ ] `read-file-tool.test.ts` - тесты инструмента чтения файлов
- [ ] `tool-validator.test.ts` - тесты валидации параметров
- [ ] `file-safety-checker.test.ts` - тесты проверок безопасности
- [ ] `git-commit-checker.test.ts` - тесты проверки git commit
- [ ] `approval-checker.test.ts` - тесты проверки разрешений

#### Интеграционные тесты:
- [ ] `mcp-handler.integration.test.ts` - полный цикл MCP запросов
  - Initialize → List Tools → Call Tool → Response
  - Обработка ошибок
  - Валидация параметров
  - Проверки безопасности

#### E2E тесты:
- [ ] `e2e-mcp-workflow.test.ts` - полный MCP workflow
  - Инъекция проб через MCP → выполнение → чтение логов

#### Критерии покрытия:
- Unit-тесты: >80% покрытия для каждого модуля
- Интеграционные тесты: Все критичные пути покрыты
- E2E тесты: Все основные сценарии покрыты

#### Оптимизация:
1. Проверить производительность (бенчмарки до/после)
2. Оптимизировать критические пути
3. Обновить документацию

## Метрики успеха
- **Размер основного файла**: < 200 строк (сейчас ~2147)
- **Количество модулей**: ~35-40 файлов
- **Покрытие тестами**: > 80%
- **Время выполнения тестов**: без изменений или улучшение
- **Добавление нового инструмента**: добавление 1 файла вместо изменения большого

## Риски и митигация
1. **Риск**: Нарушение существующей функциональности
   - **Митигация**: Пошаговая миграция с тестами на каждом этапе

2. **Риск**: Проблемы с MCP протоколом
   - **Митигация**: Тщательное тестирование всех MCP операций

3. **Риск**: Увеличение сложности из-за множества файлов
   - **Митигация**: Четкая структура директорий и документация

4. **Риск**: Проблемы с валидацией и безопасностью
   - **Митигация**: Сохранение всех проверок безопасности, добавление тестов

5. **Риск**: Проблемы с retry механизмами
   - **Митигация**: Тщательное тестирование retry логики

## Приоритеты
1. **Высокий**: Извлечение инструментов (основная функциональность)
2. **Высокий**: Извлечение валидации (критично для безопасности)
3. **Средний**: Извлечение ресурсов (улучшит читаемость)
4. **Средний**: Извлечение интеграций (упростит тестирование)
5. **Низкий**: Извлечение утилит (можно сделать первым)

## Оценка времени (обновлено с учетом тестирования и рисков)

**Базовые оценки:**
- Общее время: 15-20 рабочих дней

**С учетом рисков (×1.5-2):**
- **Общее время**: 22-30 рабочих дней
- **Минимальный MVP**: 15-18 дней (инструменты + валидация + core + базовое тестирование)
- **Полный рефакторинг**: 25-30 дней (включая полное тестирование и оптимизацию)

**Факторы увеличения:**
- Тестирование каждого модуля: +30%
- Отладка интеграций: +20%
- Код ревью и правки: +15%
- Непредвиденные проблемы: +20%

## Особые соображения
1. **MCP протокол**: Строгое соблюдение протокола MCP
2. **Безопасность**: Сохранение всех проверок безопасности
3. **Валидация**: Тщательная валидация всех входных данных
4. **Ошибки**: Единая обработка ошибок через ErrorHandler
5. **Мониторинг**: Интеграция с ContextMonitor и AnomalyDetector
6. **Retry**: Сохранение retry механизмов для надежности

## Дополнительные улучшения
1. **Плагинная архитектура**: Возможность добавления инструментов через плагины
2. **Middleware**: Система middleware для обработки запросов
3. **Кэширование**: Кэширование результатов инструментов где возможно
4. **Метрики**: Детальные метрики производительности для каждого инструмента
