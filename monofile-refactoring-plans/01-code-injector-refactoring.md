# План рефакторинга: code-injector.ts

## Текущее состояние
- **Размер**: ~1962 строки
- **Проблемы**: Монолитный файл с множественными ответственностями
- **Сложность**: Высокая - содержит логику для 15+ языков программирования

## Цели рефакторинга
1. Разделить на модули по функциональности
2. Улучшить тестируемость
3. Упростить добавление поддержки новых языков
4. Уменьшить когнитивную нагрузку

## Структура модулей после рефакторинга

### 1. `code-injector/core/` - Основная логика инъекции
**Файлы:**
- `probe-injector.ts` - Основная функция `injectProbe()`
- `probe-remover.ts` - Функции `removeProbe()`, `removeAllProbesFromFile()`
- `probe-registry.ts` - Управление реестром проб (`probeRegistry`, `getAllProbes()`)

**Ответственность:**
- Координация процесса инъекции/удаления
- Управление реестром проб
- Валидация входных параметров

### 2. `code-injector/generators/` - Генерация кода проб
**Файлы:**
- `probe-code-generator.ts` - Основная функция `generateProbeCode()`
- `language-detector.ts` - `getLanguageFromFileExtension()`
- `generators/` - Генераторы для конкретных языков:
  - `python-generator.ts`
  - `javascript-generator.ts`
  - `go-generator.ts`
  - `java-generator.ts`
  - `rust-generator.ts`
  - `cpp-generator.ts`
  - `php-generator.ts`
  - `ruby-generator.ts`
  - `csharp-generator.ts`
  - `swift-generator.ts`
  - `kotlin-generator.ts`
  - `fallback-generator.ts` - Для неизвестных языков

**Ответственность:**
- Генерация кода проб для каждого языка
- Регистрация генераторов через интерфейс `ProbeCodeGenerator`
- Fallback на JavaScript для неизвестных языков

### 3. `code-injector/host-detection/` - Определение хоста для Docker
**Файлы:**
- `host-init-generator.ts` - Генерация кода инициализации хоста
- `python-host-init.ts` - `generatePythonHostInitCode()`
- `go-host-init.ts` - `generateGoHostInitCode()`, `ensureGoProbeImports()`

**Ответственность:**
- Генерация кода определения хоста для Docker окружений
- Управление импортами для Go
- Отслеживание файлов с инициализацией (`filesWithHostInit`)

### 4. `code-injector/validation/` - Валидация синтаксиса
**Файлы:**
- `syntax-validator.ts` - Основная функция `validateSyntax()`
- `validators/` - Валидаторы для конкретных языков:
  - `python-validator.ts`
  - `javascript-validator.ts`
  - `typescript-validator.ts`
  - `go-validator.ts`
  - `java-validator.ts`
  - `rust-validator.ts`
  - `cpp-validator.ts`
  - `php-validator.ts`
  - `ruby-validator.ts`
  - `csharp-validator.ts`
  - `swift-validator.ts`
  - `kotlin-validator.ts`

**Ответственность:**
- Проверка синтаксиса после инъекции
- Rollback при обнаружении ошибок
- Конфигурация таймаутов и включения/выключения валидации

### 5. `code-injector/positioning/` - Определение позиции вставки
**Файлы:**
- `insertion-position.ts` - Логика определения позиции вставки
- `python-positioning.ts` - Специфичная для Python логика (отступы, функции, return statements)
- `indentation-handler.ts` - Обработка отступов для разных языков

**Ответственность:**
- Определение правильной позиции для вставки пробы
- Обработка отступов
- Специальная логика для Python (внутри функций, избегание недостижимого кода)

### 6. `code-injector/config/` - Конфигурация и утилиты
**Файлы:**
- `server-url.ts` - `getServerUrl()`, `findWorkspaceRoot()`
- `file-path-utils.ts` - `sanitizeFilePath()`, `getProjectRoot()`
- `config-reader.ts` - Чтение конфигурации VS Code

**Ответственность:**
- Работа с путями файлов
- Чтение конфигурации сервера
- Безопасность (path traversal protection)

### 7. `code-injector/types.ts` - Типы и интерфейсы
**Файлы:**
- `types.ts` - Все интерфейсы (`InjectionResult`, `ProbeInfo`)

**Ответственность:**
- Определение типов для всех модулей

## Этапы рефакторинга

### Этап 1: Подготовка (1-2 дня)
1. Создать структуру директорий
2. Определить интерфейсы между модулями
3. Написать план миграции

### Этап 2: Извлечение типов (0.5 дня)
1. Создать `types.ts` с всеми интерфейсами
2. Обновить импорты в основном файле

### Этап 3: Извлечение утилит (1 день)
1. Вынести `file-path-utils.ts`
2. Вынести `server-url.ts`
3. Вынести `config-reader.ts`
4. Протестировать изолированно

### Этап 4: Извлечение генераторов (2-3 дня)
1. Создать интерфейс `ProbeCodeGenerator`
2. Вынести генераторы для каждого языка
3. Создать фабрику генераторов
4. Обновить `generateProbeCode()` для использования фабрики
5. Протестировать каждый генератор

### Этап 5: Извлечение валидаторов (2-3 дня)
1. Создать интерфейс `SyntaxValidator`
2. Вынести валидаторы для каждого языка
3. Создать фабрику валидаторов
4. Обновить `validateSyntax()` для использования фабрики
5. Протестировать каждый валидатор

### Этап 6: Извлечение host detection (1 день)
1. Вынести `python-host-init.ts`
2. Вынести `go-host-init.ts`
3. Создать общий интерфейс
4. Протестировать

### Этап 7: Извлечение positioning (1-2 дня)
1. Вынести `python-positioning.ts`
2. Вынести `indentation-handler.ts`
3. Создать общий интерфейс для позиционирования
4. Протестировать

### Этап 8: Извлечение core логики (2 дня)
1. Вынести `probe-registry.ts`
2. Вынести `probe-injector.ts`
3. Вынести `probe-remover.ts`
4. Обновить зависимости
5. Протестировать интеграцию

### Этап 9: Рефакторинг основного файла (1 день)
1. Оставить только экспорты и координацию
2. Удалить дублирующийся код
3. Обновить документацию

### Этап 10: Тестирование и оптимизация (2-3 дня)
1. Написать интеграционные тесты
2. Проверить производительность
3. Оптимизировать критические пути
4. Обновить документацию

## Метрики успеха
- **Размер основного файла**: < 200 строк (сейчас ~1962)
- **Количество модулей**: ~25-30 файлов
- **Покрытие тестами**: > 80%
- **Время выполнения тестов**: без изменений или улучшение
- **Поддержка новых языков**: добавление 1 файла вместо изменения большого

## Риски и митигация
1. **Риск**: Нарушение существующей функциональности
   - **Митигация**: Пошаговая миграция с тестами на каждом этапе

2. **Риск**: Увеличение сложности из-за множества файлов
   - **Митигация**: Четкая структура директорий и документация

3. **Риск**: Проблемы с циклическими зависимостями
   - **Митигация**: Тщательное проектирование интерфейсов

## Приоритеты
1. **Высокий**: Извлечение генераторов (упростит добавление языков)
2. **Высокий**: Извлечение валидаторов (критично для безопасности)
3. **Средний**: Извлечение positioning (улучшит читаемость)
4. **Средний**: Извлечение host detection (изолирует Docker логику)
5. **Низкий**: Рефакторинг core (можно сделать последним)

## Оценка времени
- **Общее время**: 12-18 рабочих дней
- **Минимальный MVP**: 8-10 дней (генераторы + валидаторы + core)
- **Полный рефакторинг**: 15-18 дней
