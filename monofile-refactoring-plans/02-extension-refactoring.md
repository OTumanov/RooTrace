# План рефакторинга: extension.ts

## Текущее состояние
- **Размер**: ~2129 строк
- **Проблемы**: Монолитный файл с множественными ответственностями
- **Сложность**: Очень высокая - содержит активацию, HTTP сервер, WebView, команды, логирование

## Цели рефакторинга
1. Разделить на модули по функциональности
2. Улучшить тестируемость
3. Упростить поддержку
4. Изолировать зависимости от VS Code API

## Структура модулей после рефакторинга

### 1. `extension/core/` - Основная логика расширения
**Файлы:**
- `extension-activator.ts` - Функция `activate()`
- `extension-deactivator.ts` - Функция `deactivate()`
- `extension-context.ts` - Управление контекстом расширения

**Ответственность:**
- Координация активации/деактивации
- Регистрация команд
- Управление подписками

### 2. `extension/server/` - HTTP сервер
**Файлы:**
- `http-server.ts` - Основной класс `HttpServer`
- `server-handlers.ts` - Обработчики запросов (POST /, GET /logs, GET /health, GET /diagnostics)
- `server-config.ts` - Конфигурация сервера (порт, rate limiting)
- `rate-limiter.ts` - Логика rate limiting

**Ответственность:**
- Управление HTTP сервером
- Обработка входящих запросов
- Rate limiting
- Health checks

### 3. `extension/dashboard/` - WebView Dashboard
**Файлы:**
- `dashboard-manager.ts` - Управление панелью дашборда
- `dashboard-html.ts` - Генерация HTML контента
- `dashboard-message-handler.ts` - Обработка сообщений от WebView
- `dashboard-styles.ts` - CSS стили (вынести из HTML)

**Ответственность:**
- Создание и управление WebView панелью
- Генерация HTML/CSS/JS
- Обработка взаимодействий пользователя

### 4. `extension/commands/` - VS Code команды
**Файлы:**
- `command-registry.ts` - Регистрация всех команд
- `commands/` - Отдельные команды:
  - `start-server-command.ts`
  - `stop-server-command.ts`
  - `clear-logs-command.ts`
  - `open-dashboard-command.ts`
  - `read-runtime-logs-command.ts`
  - `clear-session-command.ts`
  - `show-user-instructions-command.ts`
  - `export-logs-command.ts` (JSON, CSV, Markdown, HTML)
  - `cleanup-command.ts`

**Ответственность:**
- Регистрация команд VS Code
- Обработка команд пользователя
- Интеграция с UI

### 5. `extension/logging/` - Логирование
**Файлы:**
- `log-manager.ts` - Управление логами
- `log-formatter.ts` - Форматирование логов (`formatLogEntry()`)
- `log-storage-adapter.ts` - Адаптер для `SharedLogStorage`
- `output-channel-manager.ts` - Управление Output Channel

**Ответственность:**
- Логирование в Output Channel
- Форматирование логов
- Интеграция с SharedLogStorage

### 6. `extension/config/` - Конфигурация
**Файлы:**
- `config-manager.ts` - Управление конфигурацией
- `ai-debug-config.ts` - Работа с `.ai_debug_config` файлом
- `port-manager.ts` - Управление портом сервера (сохранение/чтение из файла)
- `workspace-config.ts` - Конфигурация workspace

**Ответственность:**
- Чтение/запись конфигурационных файлов
- Управление портом
- Работа с workspace

### 7. `extension/prompts/` - Управление промптами
**Файлы:**
- `prompt-modules-copier.ts` - `copyPromptModules()`
- `prompt-watcher.ts` - Отслеживание изменений промптов

**Ответственность:**
- Копирование модулей промптов в workspace
- Отслеживание изменений промптов
- Обновление `.roomodes`

### 8. `extension/ui-bridge/` - UI Bridge для MCP
**Файлы:**
- `ui-event-handler.ts` - Обработка UI событий из `.rootrace/ui.json`
- `ui-response-manager.ts` - Управление ответами пользователя
- `user-approval-manager.ts` - Управление разрешениями пользователя

**Ответственность:**
- Связь между MCP сервером и VS Code UI
- Обработка событий пользователя
- Управление разрешениями

### 9. `extension/websocket/` - WebSocket поддержка
**Файлы:**
- `websocket-manager.ts` - Управление WebSocket соединениями
- `websocket-handlers.ts` - Обработчики WebSocket событий

**Ответственность:**
- Управление WebSocket клиентами
- Отправка real-time обновлений
- Очистка неактивных клиентов

### 10. `extension/integration/` - Интеграции
**Файлы:**
- `mcp-integration.ts` - Интеграция с MCP сервером
- `role-sync.ts` - Синхронизация роли с Roo Code
- `session-integration.ts` - Интеграция с SessionManager

**Ответственность:**
- Интеграция с внешними системами
- Синхронизация состояния

### 11. `extension/utils/` - Утилиты
**Файлы:**
- `html-escape.ts` - `escapeHtml()`
- `workspace-utils.ts` - Утилиты для работы с workspace
- `file-utils.ts` - Утилиты для работы с файлами

**Ответственность:**
- Вспомогательные функции
- Утилиты общего назначения

## Этапы рефакторинга

### Этап 1: Подготовка (1 день)
1. Создать структуру директорий
2. Определить интерфейсы между модулями
3. Написать план миграции

### Этап 2: Извлечение утилит (0.5 дня)
1. Вынести `html-escape.ts`
2. Вынести `workspace-utils.ts`
3. Вынести `file-utils.ts`

### Этап 3: Извлечение конфигурации (1 день)
1. Вынести `config-manager.ts`
2. Вынести `ai-debug-config.ts`
3. Вынести `port-manager.ts`
4. Вынести `workspace-config.ts`
5. Протестировать

### Этап 4: Извлечение логирования (1 день)
1. Вынести `log-manager.ts`
2. Вынести `log-formatter.ts`
3. Вынести `log-storage-adapter.ts`
4. Вынести `output-channel-manager.ts`
5. Протестировать

### Этап 5: Извлечение HTTP сервера (2-3 дня)
1. Создать класс `HttpServer`
2. Вынести обработчики запросов
3. Вынести rate limiting
4. Вынести конфигурацию сервера
5. Протестировать изолированно

### Этап 6: Извлечение Dashboard (2-3 дня)
1. Вынести `dashboard-manager.ts`
2. Вынести генерацию HTML
3. Вынести обработку сообщений
4. Вынести стили в отдельный файл
5. Протестировать

### Этап 7: Извлечение команд (2 дня)
1. Создать `command-registry.ts`
2. Вынести каждую команду в отдельный файл
3. Обновить регистрацию команд
4. Протестировать каждую команду

### Этап 8: Извлечение UI Bridge (1 день)
1. Вынести `ui-event-handler.ts`
2. Вынести `ui-response-manager.ts`
3. Вынести `user-approval-manager.ts`
4. Протестировать

### Этап 9: Извлечение WebSocket (1 день)
1. Вынести `websocket-manager.ts`
2. Вынести обработчики WebSocket
3. Протестировать

### Этап 10: Извлечение интеграций (1 день)
1. Вынести `mcp-integration.ts`
2. Вынести `role-sync.ts`
3. Вынести `session-integration.ts`
4. Протестировать

### Этап 11: Извлечение промптов (0.5 дня)
1. Вынести `prompt-modules-copier.ts`
2. Вынести `prompt-watcher.ts`
3. Протестировать

### Этап 12: Рефакторинг основного файла (1 день)
1. Оставить только `activate()` и `deactivate()`
2. Удалить дублирующийся код
3. Обновить документацию

### Этап 13: Тестирование и оптимизация (2-3 дня)
1. Написать интеграционные тесты
2. Проверить производительность
3. Оптимизировать критические пути
4. Обновить документацию

## Метрики успеха
- **Размер основного файла**: < 150 строк (сейчас ~2129)
- **Количество модулей**: ~30-35 файлов
- **Покрытие тестами**: > 80%
- **Время выполнения тестов**: без изменений или улучшение
- **Изоляция VS Code API**: четкое разделение

## Риски и митигация
1. **Риск**: Нарушение существующей функциональности
   - **Митигация**: Пошаговая миграция с тестами на каждом этапе

2. **Риск**: Проблемы с зависимостями VS Code API
   - **Митигация**: Создание абстракций для VS Code API

3. **Риск**: Увеличение сложности из-за множества файлов
   - **Митигация**: Четкая структура директорий и документация

4. **Риск**: Проблемы с асинхронной инициализацией
   - **Митигация**: Тщательное управление порядком инициализации

## Приоритеты
1. **Высокий**: Извлечение HTTP сервера (критично для функциональности)
2. **Высокий**: Извлечение Dashboard (большой блок кода)
3. **Средний**: Извлечение команд (улучшит читаемость)
4. **Средний**: Извлечение логирования (упростит тестирование)
5. **Низкий**: Извлечение утилит (можно сделать первым)

## Оценка времени
- **Общее время**: 15-20 рабочих дней
- **Минимальный MVP**: 10-12 дней (сервер + dashboard + команды)
- **Полный рефакторинг**: 18-20 дней

## Особые соображения
1. **VS Code API**: Создать абстракции для тестирования
2. **Асинхронность**: Тщательно управлять порядком инициализации
3. **Состояние**: Четко определить, где хранится состояние (singleton vs dependency injection)
4. **Ошибки**: Единая обработка ошибок через ErrorHandler
