# Чеклист для ручного тестирования MCP Handler

После рефакторинга монолитного `mcp-handler.ts` в модульную структуру необходимо проверить работоспособность всех компонентов.

## Подготовка

- [ ] Убедиться, что проект собирается без ошибок: `npm run build`
- [ ] Убедиться, что все тесты проходят: `npm test`
- [ ] Проверить, что нет ошибок линтера: `npm run lint` (если есть)

## Базовые MCP запросы

### Initialize Request
- [ ] MCP сервер успешно инициализируется
- [ ] Возвращается правильная версия протокола (2024-11-05)
- [ ] Возвращается информация о сервере (name: 'RooTrace', version: '1.0.0')

### ListTools Request
- [ ] Возвращается список всех 10 инструментов
- [ ] Каждый инструмент имеет правильную схему (name, description, inputSchema)

### ListResources Request
- [ ] Возвращаются базовые ресурсы (logs, status, rules)
- [ ] Возвращаются ресурсы для модулей правил из .roo/roo-trace-rules/
- [ ] Ограничение на количество ресурсов работает (максимум 50)

### ReadResource Request
- [ ] `roo-trace://logs` - возвращает логи в формате JSON
- [ ] `roo-trace://status` - возвращает статус с uptime и активными гипотезами
- [ ] `roo-trace://rules` - возвращает список модулей правил
- [ ] `roo-trace://rule/{filename}` - возвращает содержимое конкретного модуля правила
- [ ] Обработка несуществующих ресурсов возвращает ошибку

## Инструменты (Tools)

### read_runtime_logs
- [ ] Без одобрения пользователя возвращает ошибку FORBIDDEN
- [ ] С одобрением пользователя возвращает логи
- [ ] Queued запросы (__queued=true) проходят без одобрения
- [ ] Логи корректно форматируются

### clear_logs
- [ ] Успешно очищает все логи
- [ ] Возвращает подтверждение очистки

### get_debug_status
- [ ] Возвращает статус сервера (active/inactive/error)
- [ ] Возвращает список активных гипотез
- [ ] Возвращает uptime сервера
- [ ] Тестирование сервера (testServerWriteRead) работает корректно

### clear_session
- [ ] Удаляет все пробы из всех файлов
- [ ] Очищает все логи
- [ ] Находит файлы с пробами из всех источников (реестр, логи, сканирование)
- [ ] Обрабатывает ошибки при удалении проб

### inject_probes
- [ ] Валидация параметров работает (неверные параметры возвращают ошибку)
- [ ] Проверка git commit работает (требует коммит или .bak)
- [ ] Запрет инъекции в Python файлы работает
- [ ] Retry механизм работает при временных ошибках
- [ ] Проба успешно инъектируется в код
- [ ] Обработка ошибок работает корректно

### inject_multiple_probes
- [ ] Валидация всех проб работает
- [ ] Проверка git commit для всех уникальных файлов работает
- [ ] Все пробы успешно инъектируются
- [ ] Частичные ошибки обрабатываются корректно

### show_user_instructions
- [ ] Создает ui.json файл с инструкциями
- [ ] Ожидает ответ пользователя через ui-response.json
- [ ] Возвращает выбор пользователя
- [ ] Обрабатывает таймаут (2 минуты)

### read_file
- [ ] Чтение одного файла работает
- [ ] Чтение нескольких файлов работает
- [ ] Диапазоны строк работают (startLine, endLine)
- [ ] Обработка несуществующих файлов возвращает ошибку
- [ ] Поддержка @ префикса для путей работает

### get_problems
- [ ] Возвращает диагностики из VS Code сервера
- [ ] Фильтрация по файлам работает
- [ ] Обработка ошибок подключения к серверу работает

### load_rule
- [ ] Загружает правило из .roo/roo-trace-rules/
- [ ] Возвращает содержимое правила
- [ ] Обработка несуществующих правил возвращает ошибку

## Безопасность

### Проверка разрешений на чтение логов
- [ ] Без файла одобрения возвращает ошибку
- [ ] С истекшим одобрением возвращает ошибку
- [ ] С валидным одобрением разрешает доступ
- [ ] Auto-debug approval работает (5 минут)

### Проверка git commit
- [ ] Требует коммит или .bak для файлов с изменениями
- [ ] Разрешает редактирование для чистых файлов
- [ ] Отслеживает проверенные файлы в сессии (committedFiles)

## Интеграция

- [ ] MCP сервер запускается через `mcp-server.ts`
- [ ] Все импорты из `./mcp-handler` работают корректно
- [ ] Реэкспорт из `mcp-handler/index.ts` работает
- [ ] Нет циклических зависимостей

## Производительность

- [ ] Время ответа на запросы приемлемое (< 1 секунда для большинства операций)
- [ ] Нет утечек памяти при множественных запросах
- [ ] Retry механизм не создает излишних задержек

## Обработка ошибок

- [ ] Все ошибки логируются корректно
- [ ] Ошибки возвращаются в правильном формате (CallToolResult с isError: true)
- [ ] Временные ошибки обрабатываются через retry
- [ ] Критические ошибки не ломают сервер

## Дополнительные проверки

- [ ] Все обработчики используют HandlerContext корректно
- [ ] Нет прямых зависимостей между обработчиками (только через context)
- [ ] Все утилиты экспортируются через index.ts
- [ ] Документация (JSDoc) присутствует для публичных API

## Результаты тестирования

**Дата тестирования:** _______________

**Тестировщик:** _______________

**Результат:** 
- [ ] Все проверки пройдены
- [ ] Есть проблемы (описать ниже)

**Найденные проблемы:**

1. 
2. 
3. 

**Рекомендации:**

1. 
2. 
3. 
