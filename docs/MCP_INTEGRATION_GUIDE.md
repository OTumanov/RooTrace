# Руководство по интеграции с Model Context Protocol (MCP) для RooTrace

## Обзор

RooTrace - это MCP-сервер, интегрированный с расширением Debug Sidecar для VSCode. Он обеспечивает глубокую интеграцию с AI-ассистентами (Roo Code или Roo Cline) через стандартизированный протокол Model Context Protocol (MCP), позволяя эффективно управлять отладочными сессиями и инструментами.

## Архитектура MCP

### Общая архитектура
```
┌─────────────────────────────────────────────────────────────────┐
│           Roo Code / Roo Cline (AI Assistant)              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         MCP Client Interface                             │  │
│  │  - Invokes MCP tools via stdio                          │  │
│  │  - Processes tool responses                              │  │
│  │  - Integrates with debugging workflow                    │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                   │ (stdio)
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│              RooTrace MCP Server (mcp-server.js)              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         MCP Handler (mcp-handler.ts)                    │  │
│  │  - read_runtime_logs                                     │  │
│  │  - get_debug_status                                     │  │
│  │  - clear_session                                        │  │
│  │  - inject_probes                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         DebugSession (in-memory storage)                  │  │
│  │  - Hypotheses: H1, H2, H3 (pre-configured)         │  │
│  │  - Logs: up to 1000 entries                           │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│              Debug Sidecar Extension (extension.ts)              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         HTTP Server (localhost:random_port)              │  │
│  │  - Accepts POST / with debug data                       │  │
│  │  - GET /logs returns in-memory logs                     │  │
│  │  - CORS headers enabled                                 │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         Log Storage                                       │  │
│  │  - In-memory: string[]                                 │  │
│  │  - Persistent: .ai_debug_logs.json                     │  │
│  │  - Output Channel: "AI Debugger"                        │  │
│  │  - WebView Dashboard                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## MCP-инструменты

### 1. `read_runtime_logs`

**Назначение**: Получает логи отладочной сессии RooTrace

**Параметры**:
- `sessionId` (опционально): ID сессии для получения логов (если не указан, возвращаются логи текущей сессии)

**Пример вызова**:
```json
{
  "name": "read_runtime_logs",
  "arguments": {
    "sessionId": "session-123"
  }
}
```

**Пример ответа**:
```json
{
  "result": {
    "logs": [
      {
        "timestamp": "2026-01-18T10:00:00.000Z",
        "hypothesisId": "H1",
        "context": "Variable check",
        "data": {
          "variableValue": 42
        }
      }
    ],
    "count": 1,
    "sessionId": "session-123"
  }
}
```

### 2. `get_debug_status`

**Назначение**: Возвращает статус сервера (активен/не активен), список активных гипотез и текущую сессию

**Параметры**: Нет

**Пример вызова**:
```json
{
  "name": "get_debug_status",
  "arguments": {}
}
```

**Пример ответа**:
```json
{
  "result": {
    "serverStatus": "active",
    "activeHypotheses": [
      {
        "id": "H1",
        "status": "active",
        "description": "Primary hypothesis"
      }
    ],
    "currentSession": "default-session",
    "lastUpdated": "2026-01-18T10:00:00.000Z"
  }
}
```

### 3. `clear_session`

**Назначение**: Очищает сессию отладки RooTrace, сбрасывает все гипотезы и логи

**Параметры**:
- `sessionId` (опционально): ID сессии для очистки (если не указан, очищается текущая сессия)

**Пример вызова**:
```json
{
  "name": "clear_session",
  "arguments": {
    "sessionId": "session-123"
  }
}
```

**Пример ответа**:
```json
{
  "result": {
    "success": true,
    "message": "Сессия отладки RooTrace успешно очищена",
    "sessionId": "session-123",
    "clearedAt": "2026-01-18T10:00:00.000Z"
  }
}
```

### 4. `inject_probes`

**Назначение**: Инъекция проб в код для дополнительной отладочной информации

**Параметры**:
- `filePath`: Путь к файлу для инъекции проб
- `lineNumber`: Номер строки для инъекции пробы
- `probeType`: Тип пробы ('log', 'trace', 'error')
- `message`: Сообщение для пробы

**Пример вызова**:
```json
{
  "name": "inject_probes",
  "arguments": {
    "filePath": "./src/main.js",
    "lineNumber": 42,
    "probeType": "log",
    "message": "Checking variable value"
  }
}
```

**Пример ответа**:
```json
{
  "result": {
    "success": true,
    "filePath": "./src/main.js",
    "lineNumber": 42,
    "probeType": "log",
    "message": "Checking variable value",
    "confirmation": "Successfully injected log probe at ./src/main.js:42",
    "insertedCode": "console.log('[RooTrace]: Checking variable value');"
  }
}
```

## Как Roo Code / Roo Cline использует RooTrace через MCP

### 1. Автоматическая детекция и регистрация
При активации расширения Debug Sidecar происходит автоматическая детекция и регистрация:

1. Расширение автоматически детектирует установленное расширение (Roo Code или Roo Cline)
2. Создаёт конфигурацию в файле `.roo/mcp.json` в корне рабочей области
3. Формат конфигурации зависит от установленного расширения
4. Все инструменты становятся доступны для AI-ассистента
5. Процесс полностью автоматизирован (Zero-Config)

### 2. Взаимодействие с инструментами
Roo Code или Roo Cline может вызывать MCP-инструменты напрямую через stdio:

```
Roo Code / Roo Cline -> MCP Client (stdio) -> RooTrace Server -> DebugSession
```

### 3. Примеры использования

#### Получение логов
```
Roo Code: "Покажи мне последние отладочные логи"
-> вызывает read_runtime_logs
-> получает актуальные логи отладки
-> анализирует и представляет результаты пользователю
```

#### Проверка статуса
```
Roo Code: "Какие гипотезы активны?"
-> вызывает get_debug_status
-> получает список активных гипотез
-> показывает пользователю текущее состояние отладки
```

#### Инъекция проб
```
Roo Code: "Добавь отладочную точку в файл main.js на строку 42"
-> вызывает inject_probes с параметрами
-> сервер внедряет пробу в код
-> возвращает подтверждение
```

## Troubleshooting

### Проблема: MCP-инструменты недоступны
**Решение**:
1. Проверьте, что расширение Debug Sidecar активно
2. Проверьте наличие файла `.roo/mcp.json` в корне рабочей области
3. Убедитесь, что Roo Code или Roo Cline установлено и активно
4. Перезапустите VSCode после изменения конфигурации
5. Проверьте формат конфигурации в `.roo/mcp.json` (должен соответствовать Roo Code или Roo Cline)

### Проблема: Ошибка при вызове инструмента
**Решение**:
1. Проверьте правильность параметров вызова
2. Убедитесь, что файл существует (для `inject_probes`)
3. Проверьте номер строки (для `inject_probes`)
4. Посмотрите логи расширения в Output канале "Debug Sidecar"

### Проблема: Сервер не отвечает
**Решение**:
1. Проверьте, что сервер запущен (он должен запускаться автоматически)
2. Убедитесь, что нет конфликта портов
3. Проверьте, что расширение не было отключено

### Диагностика
Для диагностики проблем:

1. Откройте Output панель в VSCode
2. Выберите "AI Debugger" из выпадающего списка
3. Выполните вызов инструмента через Roo Code / Roo Cline и наблюдайте за логами
4. Проверьте файл `.roo/mcp.json` в корне рабочей области
5. Проверьте наличие файла `.ai_debug_logs.json` для персистентного хранения логов

## Технические детали

### Детекция расширения
Расширение автоматически детектирует установленное расширение:
- **Roo Code**: создаёт конфигурацию в формате `{"servers": [...]}`
- **Roo Cline**: создаёт конфигурацию в формате `{"mcpServers": {...}}`

### Роутинг вызовов
- Все вызовы инструментов маршрутизируются через stdio (стандартный ввод/вывод)
- Проверка параметров осуществляется на уровне MCP-сервера
- Валидация данных происходит до выполнения операций

### Хранение данных
- **In-memory**: до 1000 записей логов в памяти расширения
- **Persistent**: файл `.ai_debug_logs.json` для долгосрочного хранения
- **Output Channel**: канал "AI Debugger" для отображения в VSCode
- **WebView Dashboard**: визуализация логов в реальном времени

### Безопасность
- HTTP-сервер слушает только на localhost
- MCP-сервер работает через stdio в изолированном процессе
- Все файловые операции ограничены рабочей областью проекта
- Проверка путей файлов предотвращает выход за пределы проекта

### Производительность
- MCP-сервер оптимизирован для быстрого отклика через stdio
- Логика обработки запросов асинхронна
- Лимит логов: 1000 записей для предотвращения переполнения памяти
- HTTP-сервер поддерживает CORS для браузерных приложений

## Заключение

Интеграция с MCP позволяет RooTrace обеспечивать стандартизированный интерфейс для отладочных инструментов, обеспечивая надежное и масштабируемое взаимодействие между AI-ассистентами (Roo Code или Roo Cline) и отладочной системой. Архитектура Zero-Config с автоматической детекцией расширения делает использование системы максимально простым для пользователей.

## Дополнительные ресурсы

- [Исходный код расширения](../src/extension.ts) - основной код расширения
- [MCP Handler](../src/mcp-handler.ts) - реализация MCP-инструментов
- [MCP Registration](../src/mcp-registration.ts) - автоматическая регистрация MCP-сервера
- [MCP Server](../src/mcp-server.ts) - точка входа MCP-сервера
- [Code Injector](../src/code-injector.ts) - инъекция проб в код