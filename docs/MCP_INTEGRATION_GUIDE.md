# Руководство по интеграции с Model Context Protocol (MCP) для RooTrace

## Обзор

RooTrace - это MCP-сервер, интегрированный с расширением Debug Sidecar для VSCode. Он обеспечивает глубокую интеграцию с AI-ассистентами через стандартизированный протокол Model Context Protocol (MCP), позволяя эффективно управлять отладочными сессиями и инструментами.

## Архитектура MCP

### Общая архитектура
```
┌─────────────────────────────────────────────────────────────────┐
│                    Roo Code AI Assistant                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         MCP Client Interface                             │  │
│  │  - Invokes MCP tools                                     │  │
│  │  - Processes tool responses                              │  │
│  │  - Integrates with debugging workflow                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         RooTrace MCP Server                              │  │
│  │  - Handles debug-specific tools                          │  │
│  │  - Manages hypothesis tracking                           │  │
│  │  - Provides probe injection capabilities                 │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Debug Sidecar Extension                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         MCP Registration Layer                           │  │
│  │  - Auto-registers RooTrace server                        │  │
│  │  - Manages server lifecycle                              │  │
│  │  - Handles tool permissions                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │         Code Instrumentation Module                      │  │
│  │  - AST parsing and code modification                     │  │
│  │  - Probe injection at runtime                            │  │
│  │  - Multi-language support                                │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## MCP-инструменты

### 1. `read_runtime_logs`

**Назначение**: Получает логи отладочной сессии RooTrace

**Параметры**:
- `sessionId` (опционально): ID сессии для получения логов (если не указан, возвращаются логи текущей сессии)

**Пример вызова**:
```json
{
  "name": "read_runtime_logs",
  "arguments": {
    "sessionId": "session-123"
  }
}
```

**Пример ответа**:
```json
{
  "result": {
    "logs": [
      {
        "timestamp": "2026-01-18T10:00:00.000Z",
        "hypothesisId": "H1",
        "context": "Variable check",
        "data": {
          "variableValue": 42
        }
      }
    ],
    "count": 1,
    "sessionId": "session-123"
  }
}
```

### 2. `get_debug_status`

**Назначение**: Возвращает статус сервера (активен/не активен), список активных гипотез и текущую сессию

**Параметры**: Нет

**Пример вызова**:
```json
{
  "name": "get_debug_status",
  "arguments": {}
}
```

**Пример ответа**:
```json
{
  "result": {
    "serverStatus": "active",
    "activeHypotheses": [
      {
        "id": "H1",
        "status": "active",
        "description": "Primary hypothesis"
      }
    ],
    "currentSession": "default-session",
    "lastUpdated": "2026-01-18T10:00:00.000Z"
  }
}
```

### 3. `clear_session`

**Назначение**: Очищает сессию отладки RooTrace, сбрасывает все гипотезы и логи

**Параметры**:
- `sessionId` (опционально): ID сессии для очистки (если не указан, очищается текущая сессия)

**Пример вызова**:
```json
{
  "name": "clear_session",
  "arguments": {
    "sessionId": "session-123"
  }
}
```

**Пример ответа**:
```json
{
  "result": {
    "success": true,
    "message": "Сессия отладки RooTrace успешно очищена",
    "sessionId": "session-123",
    "clearedAt": "2026-01-18T10:00:00.000Z"
  }
}
```

### 4. `inject_probes`

**Назначение**: Инъекция проб в код для дополнительной отладочной информации

**Параметры**:
- `filePath`: Путь к файлу для инъекции проб
- `lineNumber`: Номер строки для инъекции пробы
- `probeType`: Тип пробы ('log', 'trace', 'error')
- `message`: Сообщение для пробы

**Пример вызова**:
```json
{
  "name": "inject_probes",
  "arguments": {
    "filePath": "./src/main.js",
    "lineNumber": 42,
    "probeType": "log",
    "message": "Checking variable value"
  }
}
```

**Пример ответа**:
```json
{
  "result": {
    "success": true,
    "filePath": "./src/main.js",
    "lineNumber": 42,
    "probeType": "log",
    "message": "Checking variable value",
    "confirmation": "Successfully injected log probe at ./src/main.js:42",
    "insertedCode": "console.log('[RooTrace]: Checking variable value');"
  }
}
```

## Как Roo Code использует RooTrace через MCP

### 1. Автоматическая регистрация
При активации расширения Debug Sidecar происходит автоматическая регистрация сервера RooTrace в системе MCP:

1. Сервер регистрируется в конфигурационном файле MCP
2. Все инструменты становятся доступны для Roo Code
3. Процесс полностью автоматизирован (Zero-Config)

### 2. Взаимодействие с инструментами
Roo Code может вызывать MCP-инструменты напрямую:

```
Roo Code -> MCP Client -> RooTrace Server -> Debug Session
```

### 3. Примеры использования

#### Получение логов
```
Roo Code: "Покажи мне последние отладочные логи"
-> вызывает read_runtime_logs
-> получает актуальные логи отладки
-> анализирует и представляет результаты пользователю
```

#### Проверка статуса
```
Roo Code: "Какие гипотезы активны?"
-> вызывает get_debug_status
-> получает список активных гипотез
-> показывает пользователю текущее состояние отладки
```

#### Инъекция проб
```
Roo Code: "Добавь отладочную точку в файл main.js на строку 42"
-> вызывает inject_probes с параметрами
-> сервер внедряет пробу в код
-> возвращает подтверждение
```

## Troubleshooting

### Проблема: MCP-инструменты недоступны
**Решение**:
1. Проверьте, что расширение Debug Sidecar активно
2. Убедитесь, что сервер RooTrace зарегистрирован в MCP
3. Перезапустите VSCode
4. Проверьте файл конфигурации MCP в `~/.config/Code/User/globalStorage/rooveterinaryinc.roo-code/settings/mcpConfig.json`

### Проблема: Ошибка при вызове инструмента
**Решение**:
1. Проверьте правильность параметров вызова
2. Убедитесь, что файл существует (для `inject_probes`)
3. Проверьте номер строки (для `inject_probes`)
4. Посмотрите логи расширения в Output канале "Debug Sidecar"

### Проблема: Сервер не отвечает
**Решение**:
1. Проверьте, что сервер запущен (он должен запускаться автоматически)
2. Убедитесь, что нет конфликта портов
3. Проверьте, что расширение не было отключено

### Диагностика
Для диагностики проблем:

1. Откройте Output панель в VSCode
2. Выберите "Debug Sidecar" из выпадающего списка
3. Выполните вызов инструмента и наблюдайте за логами
4. Проверьте файл `mcpConfig.json` в директории настроек

## Технические детали

### Роутинг вызовов
- Все вызовы инструментов маршрутизируются через MCP протокол
- Проверка параметров осуществляется на уровне сервера
- Валидация данных происходит до выполнения операций

### Безопасность
- Сервер работает только в рамках локального окружения
- Все файловые операции ограничены рабочей областью проекта
- Проверка путей файлов предотвращает выход за пределы проекта

### Производительность
- MCP-сервер оптимизирован для быстрого отклика
- Логика обработки запросов асинхронна
- Ресурсоемкие операции выполняются в фоновом режиме

## Заключение

Интеграция с MCP позволяет RooTrace обеспечивать стандартизированный интерфейс для отладочных инструментов, обеспечивая надежное и масштабируемое взаимодействие между AI-ассистентом и отладочной системой. Архитектура Zero-Config делает использование системы максимально простым для пользователей.