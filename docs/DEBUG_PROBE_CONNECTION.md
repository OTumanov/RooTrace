# Отладка подключения проб к серверу

## Проблема
Код со вставками НЕ пишет в логи НИЧЕГО, но дашборд пишет тестовые данные.

## Решение: Python скрипт для диагностики

Создан скрипт `test-probe-connection.py` для отладки подключения проб к серверу.

### Как использовать:

1. **Запустите скрипт в VS Code:**
   ```bash
   python3 test-probe-connection.py
   ```

2. **Скрипт проверит:**
   - Наличие конфигурационных файлов (.rootrace/ai_debug_config или .rootrace/debug_port)
   - Доступность сервера на указанном порту
   - Отправку тестового POST запроса
   - Ответ сервера

3. **Что делать если скрипт показывает ошибки:**

   **Ошибка: "Connection refused"**
   - HTTP сервер не запущен
   - Откройте Output Channel "AI Debugger" в VS Code
   - Проверьте, что сервер запущен
   - Если сервер не запущен, перезагрузите окно VS Code или перезапустите расширение

   **Ошибка: "Файл .rootrace/debug_port не найден"**
   - Расширение не активировано или сервер не запустился
   - Убедитесь, что расширение RooTrace активировано
   - Проверьте Output Channel "AI Debugger"
   - Проверьте, что директория `.rootrace/` создана

   **Ошибка: "HTTP ошибка 404"**
   - Сервер запущен, но не обрабатывает POST запросы на `/`
   - Проверьте логи сервера в Output Channel

### Дополнительная диагностика:

1. **Проверьте файл логов проб:**
   ```bash
   cat ~/.roo_probe_debug.log
   ```
   
   Если файл существует и содержит ошибки, это означает, что:
   - Код проб выполняется (доходит до места вставки)
   - Но не может подключиться к серверу
   
   **Улучшенное логирование:**
   - Теперь код проб логирует URL, который используется
   - Логирует полный traceback при ошибках
   - Логирует успешные запросы с кодом статуса

2. **Тестируйте код пробы напрямую:**
   ```bash
   python3 test-probe-code.py
   ```
   
   Этот скрипт содержит пример кода пробы и покажет, работает ли он.

2. **Проверьте логи сервера:**
   - Откройте Output Channel "AI Debugger" в VS Code
   - Ищите строки вида `[HTTP SERVER] POST request received on /`

3. **Проверьте конфигурацию:**
   ```bash
   # Проверьте наличие файлов конфигурации
   ls -la .rootrace/ai_debug_config .rootrace/debug_port
   
   # Если .rootrace/debug_port существует, проверьте порт
   cat .rootrace/debug_port
   ```

### Типичные проблемы:

1. **Сервер не запущен**
   - Решение: Перезагрузите окно VS Code (Cmd+Shift+P -> "Reload Window")

2. **Неправильный URL в коде проб**
   - Решение: Проверьте, что `.rootrace/ai_debug_config` или `.rootrace/debug_port` содержат правильный URL/порт
   - Скрипт покажет, какой URL он использует
   - По умолчанию используется `http://localhost:51234/`

3. **Код проб не выполняется**
   - Решение: Проверьте, что код доходит до места вставки пробы
   - Проверьте файл `~/.roo_probe_debug.log` - если его нет, код не выполняется

4. **Сервер не принимает POST запросы**
   - Решение: Проверьте логи сервера в Output Channel
   - Убедитесь, что сервер обрабатывает POST на `/`

3. **Проверьте логи генерации кода проб:**
   - Откройте Output Channel "AI Debugger" в VS Code
   - Ищите строки вида `[RooTrace] Generating probe code: language=python, serverUrl=...`
   - Это покажет, какой URL используется при генерации кода пробы

4. **Если код проб не выполняется:**
   - Убедитесь, что код доходит до места вставки пробы
   - Проверьте, что проба вставлена в правильное место (не после return, не в недостижимом коде)
   - Проверьте синтаксис файла после вставки пробы

## Пример успешного вывода:

```
[2026-01-20 08:39:07] [INFO] ============================================================
[2026-01-20 08:39:07] [INFO] Запуск теста подключения проб к серверу RooTrace
[2026-01-20 08:39:07] [INFO] ============================================================
[2026-01-20 08:39:07] [INFO] Прочитан порт из .rootrace/debug_port: 51234
[2026-01-20 08:39:07] [INFO] URL сервера: http://localhost:51234/
[2026-01-20 08:39:07] [INFO] Хост доступен
[2026-01-20 08:39:07] [INFO] Получен ответ: статус 200
[2026-01-20 08:39:07] [SUCCESS] ✅ ТЕСТ ПРОЙДЕН: Подключение к серверу работает!
```
