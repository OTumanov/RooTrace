# Руководство пользователя RooTrace

## Содержание

1. [Установка](#установка)
2. [Быстрый старт](#быстрый-старт)
3. [Использование AI Debugger](#использование-ai-debugger)
4. [Устранение неполадок](#устранение-неполадок)
5. [Особенности работы с Python](#особенности-работы-с-python)

---

## Установка

### Требования

- **Node.js** версии 16.x или выше
- **Visual Studio Code** версии 1.85 или выше
- **Roo Code** или **Roo Cline** расширение (для использования MCP-инструментов)

### Установка из VSIX файла

1. Откройте Visual Studio Code
2. Перейдите в раздел "Extensions" (Расширения)
3. Нажмите на три точки (...) → "Install from VSIX..."
4. Выберите файл `roo-trace-*.vsix`
5. Перезапустите VSCode

### Сборка из исходного кода

```bash
git clone https://github.com/your-repo/roo-trace.git
cd roo-trace
npm install
npm run compile
npm run package
```

### Первый запуск

При первом открытии проекта расширение автоматически:
- Запустит HTTP-сервер на порту 51234
- Зарегистрирует MCP-сервер RooTrace
- Создаст конфигурационные файлы (`.roo/mcp.json`, `.ai_debug_logs.json`)

Проверьте канал Output > AI Debugger для подтверждения запуска.

---

## Быстрый старт

1. Откройте проект в VSCode
2. Активируйте режим AI Debugger в Roo Code/Cline
3. Сообщите AI о проблеме: "У меня возникает ошибка при..."
4. Следуйте инструкциям AI и нажимайте кнопки в чате
5. После решения проблемы AI автоматически очистит все временные изменения

---

## Использование AI Debugger

### Обзор

AI Debugger использует научный метод для выявления и устранения багов. В версии 1.0.0 реализован **Железный мост** — система безотказной файловой синхронизации, которая гарантирует надежность и отсутствие потери данных.

### Интерфейс взаимодействия

AI Debugger использует интерактивные сообщения с кнопками:

- **"Продолжить (анализ логов)"** - После запуска кода и воспроизведения ошибки
- **"Проблема устранена"** - Когда проблема решена и нужно завершить сессию

**Важно:** Во время ожидания вы можете написать сообщение AI - оно будет иметь приоритет.

### Научный метод отладки (7 фаз)

1. **Инициализация** - AI проверяет статус сервера RooTrace
2. **Формирование гипотез** - AI формирует 3-5 проверяемых гипотез (H1-H5)
3. **Инъекция проб** - AI вставляет точки отладки с UUID-маркерами
4. **Ожидание действий пользователя** - Вы запускаете код и воспроизводите баг
5. **Анализ логов** - AI собирает и анализирует логи (синхронизированные через Железный мост)
6. **Исправление** - AI предлагает и применяет исправление (цикл проверки)
7. **Очистка** - AI очищает сессию только после подтверждения

### UUID-маркеры и автоматический Rollback

Каждая проба получает уникальный ID для точного удаления:

```javascript
// RooTrace [id: a1b2] Hypothesis H1: Checking variable value
try { fetch('http://localhost:51234/', { ... }) } catch(e) {}
// RooTrace [id: a1b2]: end
```

**Важно:** 
- Если инъекция пробы приводит к ошибке синтаксиса, файл автоматически откатывается
- Вы не увидите "красных" ошибок в терминале — система защищает ваш код

### Пример полного цикла

**Пользователь:** "У меня возникает ошибка при отправке формы"

**AI:** Формирует гипотезы (H1-H5) и вставляет пробы с UUID-маркерами

**Пользователь:** Запускает код, воспроизводит баг, нажимает "Продолжить"

**AI:** Анализирует логи (синхронизированные через Железный мост), находит проблему, предлагает исправление

**Пользователь:** Подтверждает исправление, проверяет, нажимает "Проблема устранена"

**AI:** Удаляет все пробы через UUID-маркеры, обнуляет логи, проект чист

### Надежность системы

- **Железный мост**: Файловые блокировки и `fs.watchFile` для безотказной синхронизации
- **Автоматический Rollback**: Защита от битых состояний файла
- **UUID-маркеры**: Точное удаление только вставленных проб

---

## Устранение неполадок

### Расширение не активируется

**Симптомы:**
- Канал "AI Debugger" отсутствует в Output Panel
- MCP сервер не регистрируется

**Решение:**
1. Выполните команду вручную: `Cmd+Shift+P` → "RooTrace: Start Server"
2. Проверьте Developer Console: Help → Toggle Developer Tools → Console
3. Убедитесь, что workspace folder открыт
4. Пересоберите расширение: `npm run compile && vsce package`

### MCP-инструменты недоступны

**Решение:**
1. Проверьте наличие файла `.roo/mcp.json` в корне проекта
2. Убедитесь, что Roo Code или Roo Cline установлено и активно
3. Перезапустите VSCode после изменения конфигурации

### Логи не появляются в Dashboard

**Решение:**
1. Убедитесь, что HTTP-сервер запущен (проверьте Output > AI Debugger)
2. Проверьте файл `.debug_port` в корне проекта
3. Убедитесь, что отладочный код отправляет POST-запросы на `http://localhost:51234/`
4. Проверьте права доступа к файлу `.ai_debug_logs.json`

### Сервер не запускается

**Решение:**
1. Проверьте, что Node.js установлен и доступен в PATH
2. HTTP-сервер использует порт 51234 (стандартный, не требует конфигурации)
3. Перезапустите VSCode
4. Проверьте логи в Output > AI Debugger

---

## Особенности работы с Python

### Отступы для Python проб

Пробы автоматически вставляются с правильными отступами:

```python
# До инъекции:
for j in range(0, n - i - 1):
    if lst[j] < lst[j + 1]:

# После инъекции (правильно):
for j in range(0, n - i - 1):
    # RooTrace [id: a1b2] Hypothesis H1: Checking comparison
    print(f'[RooTrace]: Bubble sort comparison...')  # Правильный отступ
    # RooTrace [id: a1b2]: end
    if lst[j] < lst[j + 1]:
```

### Редактирование Python файлов

Роль "AI Debugger" может редактировать `.py` файлы. Используйте MCP инструмент `inject_probes` для добавления проб.

### Важно для Python

- Пробы всегда вставляются ПЕРЕД указанной строкой
- Отступ определяется автоматически из целевой строки
- Для Python критично сохранять правильные отступы (обычно 4 пробела на уровень)
- Проверка синтаксиса использует `python3 -m py_compile`

---

## Советы по использованию

1. **Следуйте протоколу**: AI строго следует протоколу из 7 фаз
2. **Используйте кнопки**: Нажимайте кнопки в чате после выполнения инструкций
3. **Приоритет сообщений**: Во время ожидания вы можете написать сообщение AI
4. **Циклы проверки**: После исправления AI будет проверять решение в цикле
5. **Доверьтесь системе**: Железный мост гарантирует надежность — логи не потеряются

## Важные замечания

- **Стандартный порт**: Все пробы используют `http://localhost:51234/` - не требуется конфигурация
- **MCP инструменты**: AI использует только инструменты с префиксом `mcp--roo-trace--`
- **Безотказность**: Система работает на уровне файловой системы, даже если VS Code зависнет
- **Чистота кода**: После отладки в коде не остается забытых `console.log` или закомментированных кусков
