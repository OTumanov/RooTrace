# üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏ 1.1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ SharedLogStorage

## üë®‚Äçüè´ –ü–µ–¥–∞–Ω—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä: –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ #1: –ü–ª–∞–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ
**–§–∞–∫—Ç:** –í —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ (`src/shared-log-storage.ts:312-322`) –∏–Ω–¥–µ–∫—Å—ã **–£–ñ–ï –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ª–æ–≥–∞:
```typescript
// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
if (!this.hypothesisIndex.has(log.hypothesisId)) {
  this.hypothesisIndex.set(log.hypothesisId, []);
}
this.hypothesisIndex.get(log.hypothesisId)!.push(index);
// ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è timestampIndex
```

**–í—ã–≤–æ–¥:** –ü–ª–∞–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç "—Ä–µ—à–µ–Ω–∏–µ" –¥–ª—è –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —Ä–µ—à–µ–Ω–∞. –≠—Ç–æ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –≤—ã–≥–æ–¥—ã.

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ #2: –ù–µ —É—á—Ç–µ–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
**–§–∞–∫—Ç:** `rebuildIndexes()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–±—Ä–µ–∑–∫–µ –ª–æ–≥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 330), –∫–æ–≥–¥–∞ `this.logs.length > maxLogs`.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—Ä–µ–∑–∫–µ —á–µ—Ä–µ–∑ `this.logs = this.logs.slice(-maxLogs)` –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –°—Ç–∞—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- –ù–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã (0, 1, 2, ... –≤–º–µ—Å—Ç–æ 100, 101, 102, ...)

**–í—ã–≤–æ–¥:** –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ (O(1) —É–∂–µ –µ—Å—Ç—å), –∞ –≤ **–æ–±—Ä–µ–∑–∫–µ** (O(n) rebuildIndexes).

### ‚ùå –û—à–∏–±–∫–∞ #3: –ù–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
**–§–∞–∫—Ç:** –í –ø–ª–∞–Ω–µ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `// ... –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è`, –Ω–æ:
- –ù–µ—Ç –º–µ—Ç–æ–¥–∞ `removeLog()` –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –ª–æ–≥–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ –æ–¥–Ω–æ–º—É
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Å–¥–≤–∏–≥–∞—Ç—å –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞

**–í—ã–≤–æ–¥:** –ü–ª–∞–Ω –Ω–µ–ø–æ–ª–Ω—ã–π –∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

### ‚ùå –û—à–∏–±–∫–∞ #4: –ù–µ —É—á—Ç–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
**–§–∞–∫—Ç:** –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è `timestamp` –∏–ª–∏ `hypothesisId` —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ª–æ–≥–∞, –∏–Ω–¥–µ–∫—Å—ã —Å—Ç–∞–Ω—É—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏.

**–í—ã–≤–æ–¥:** –ü–ª–∞–Ω –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –º—É—Ç–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö.

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #5: Race conditions
**–§–∞–∫—Ç:** `addLog()` –¥–µ–ª–∞–µ—Ç `await this.loadFromFile()` –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º (—Å—Ç—Ä–æ–∫–∞ 304), —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –ª–æ–≥–æ–≤ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º, –µ—Å–ª–∏ –¥–≤–∞ –ª–æ–≥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–í—ã–≤–æ–¥:** –ü–ª–∞–Ω –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø.

---

## üöÄ –°–º–µ–ª—ã–π –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

### üí° –ò–¥–µ—è #1: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ rebuildIndexes
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—Ä–µ–∑–∫–µ `slice(-maxLogs)` –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ.

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª—è—Ç—å –∏–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ —Ç–æ–ª—å–∫–æ —Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ–±—Ä–µ–∑–∞–Ω—ã:
```typescript
// –í–º–µ—Å—Ç–æ rebuildIndexes() –ø—Ä–∏ –æ–±—Ä–µ–∑–∫–µ:
const removedCount = this.logs.length - maxLogs;
const removedIndices = Array.from({ length: removedCount }, (_, i) => i);

// –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –∫–∞–∂–¥–æ–≥–æ Map
removedIndices.forEach(removedIndex => {
  // –£–¥–∞–ª—è–µ–º –∏–∑ hypothesisIndex
  this.hypothesisIndex.forEach((indices, hypothesisId) => {
    const filtered = indices.filter(idx => idx !== removedIndex && idx >= removedCount);
    const shifted = filtered.map(idx => idx - removedCount); // –°–¥–≤–∏–≥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
    this.hypothesisIndex.set(hypothesisId, shifted);
  });
  
  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è timestampIndex
});
```

**–ü—Ä–æ–±–ª–µ–º–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:** –°–ª–æ–∂–Ω–æ—Å—Ç—å O(n*m), –≥–¥–µ n - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–∏–ø–æ—Ç–µ–∑, m - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –ø–æ–ª–Ω—ã–π rebuild.

### üí° –ò–¥–µ—è #2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SortedSet –¥–ª—è timestampIndex
**–ü—Ä–æ–±–ª–µ–º–∞:** `timestampIndex` —Ö—Ä–∞–Ω–∏—Ç –º–∞—Å—Å–∏–≤—ã –∏–Ω–¥–µ–∫—Å–æ–≤, –Ω–æ –æ–Ω–∏ –Ω–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É:
```typescript
// –í–º–µ—Å—Ç–æ Map<number, number[]>
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Map<number, SortedSet<number>>
// –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Å–∏–≤—ã –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ (O(log n) –≤–º–µ—Å—Ç–æ O(1))
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è O(log n) –≤–º–µ—Å—Ç–æ O(1), —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏—è—Ö.

### üí° –ò–¥–µ—è #3: –õ–µ–Ω–∏–≤–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** `rebuildIndexes()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–µ–ª–∞—Ç—å –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–µ:
```typescript
private async rebuildIndexesAsync(): Promise<void> {
  // –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ —Ñ–æ–Ω–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
  await new Promise(resolve => setImmediate(resolve));
  this.rebuildIndexes();
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–Ω–¥–µ–∫—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –º–µ–∂–¥—É –æ–±—Ä–µ–∑–∫–æ–π –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

### üí° –ò–¥–µ—è #4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ WeakMap –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** `dayKey` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:** –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:
```typescript
private timestampCache = new WeakMap<RuntimeLog, number>();

private getDayKey(log: RuntimeLog): number {
  if (!this.timestampCache.has(log)) {
    const timestamp = new Date(log.timestamp).getTime();
    const dayKey = Math.floor(timestamp / (24 * 60 * 60 * 1000));
    this.timestampCache.set(log, dayKey);
  }
  return this.timestampCache.get(log)!;
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** WeakMap –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–∏–º–∏—Ç–∏–≤–∞–º–∏, –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.

### üí° –ò–¥–µ—è #5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–æ–≤ –º–∞—Å—Å–∏–≤–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—Ä–µ–∑–∫–µ –∏–Ω–¥–µ–∫—Å—ã –º–∞—Å—Å–∏–≤–∞ –º–µ–Ω—è—é—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –ª–æ–≥–æ–≤ –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–æ–≤:
```typescript
interface RuntimeLog {
  id: string; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
  timestamp: string;
  hypothesisId: string;
  context: string;
  data: LogData;
}

// –ò–Ω–¥–µ–∫—Å—ã —Ö—Ä–∞–Ω—è—Ç ID –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–æ–≤ –º–∞—Å—Å–∏–≤–∞
private hypothesisIndex: Map<string, string[]> = new Map(); // ID –ª–æ–≥–æ–≤
private timestampIndex: Map<number, string[]> = new Map(); // ID –ª–æ–≥–æ–≤

// –ü–æ–∏—Å–∫: O(1) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID, –∑–∞—Ç–µ–º O(n) –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –º–∞—Å—Å–∏–≤–µ
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ –ø–æ ID –≤ –º–∞—Å—Å–∏–≤–µ O(n), —á—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –ø–æ –∏–Ω–¥–µ–∫—Å—É O(1).

---

## üîÑ –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã

### –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
1. **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –£–ñ–ï –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞** (O(1))
2. **–†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –æ–±—Ä–µ–∑–∫–∞ –ª–æ–≥–æ–≤** (O(n) rebuildIndexes –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞)
3. **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤**
4. **–ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race conditions**

### –ß—Ç–æ –Ω—É–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
1. ‚úÖ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ (–≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ rebuildIndexes)
2. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤
3. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions
4. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –†–µ—à–µ–Ω–∏–µ: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

```typescript
class SharedLogStorage {
  // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–æ–≤
  private indexesValid: boolean = true;
  private pendingRebuild: boolean = false;
  
  async addLog(log: RuntimeLog): Promise<void> {
    await this.loadFromFile();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
    if (!this.indexesValid) {
      this.rebuildIndexes();
      this.indexesValid = true;
    }
    
    const index = this.logs.length;
    this.logs.push(log);
    
    // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—É–∂–µ –µ—Å—Ç—å, –Ω–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
    this.updateIndexesForLog(log, index, 'add');
    
    // –û–±—Ä–µ–∑–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
    const maxLogs = this.getMaxLogs();
    if (this.logs.length > maxLogs) {
      await this.trimLogsIncremental(maxLogs);
    }
    
    await this.saveToFile(this.logs);
    this.emit('logAdded', log);
  }
  
  // –ù–û–í–´–ô –ú–ï–¢–û–î: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞
  private async trimLogsIncremental(maxLogs: number): Promise<void> {
    const removedCount = this.logs.length - maxLogs;
    
    if (removedCount > maxLogs / 2) {
      // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã - –ø–æ–ª–Ω—ã–π rebuild –±—ã—Å—Ç—Ä–µ–µ
      this.logs = this.logs.slice(-maxLogs);
      this.rebuildIndexes();
      this.indexesValid = true;
    } else {
      // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –¥–ª—è –º–∞–ª—ã—Ö —É–¥–∞–ª–µ–Ω–∏–π
      const removedIndices = Array.from({ length: removedCount }, (_, i) => i);
      
      // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —Å–¥–≤–∏–≥–∞–µ–º
      this.hypothesisIndex.forEach((indices, hypothesisId) => {
        const filtered = indices
          .filter(idx => !removedIndices.includes(idx))
          .map(idx => idx - removedCount);
        this.hypothesisIndex.set(hypothesisId, filtered);
      });
      
      this.timestampIndex.forEach((indices, dayKey) => {
        const filtered = indices
          .filter(idx => !removedIndices.includes(idx))
          .map(idx => idx - removedCount);
        this.timestampIndex.set(dayKey, filtered);
      });
      
      this.logs = this.logs.slice(-maxLogs);
      this.indexesValid = true;
    }
  }
  
  // –ù–û–í–´–ô –ú–ï–¢–û–î: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
  private updateIndexesForLog(log: RuntimeLog, index: number, action: 'add' | 'remove'): void {
    if (action === 'add') {
      if (!this.hypothesisIndex.has(log.hypothesisId)) {
        this.hypothesisIndex.set(log.hypothesisId, []);
      }
      this.hypothesisIndex.get(log.hypothesisId)!.push(index);
      
      const timestamp = new Date(log.timestamp).getTime();
      const dayKey = Math.floor(timestamp / (24 * 60 * 60 * 1000));
      if (!this.timestampIndex.has(dayKey)) {
        this.timestampIndex.set(dayKey, []);
      }
      this.timestampIndex.get(dayKey)!.push(index);
    } else {
      // –£–¥–∞–ª–µ–Ω–∏–µ: —É–¥–∞–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –∏ —Å–¥–≤–∏–≥–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ –Ω–µ–≥–æ
      this.removeIndexFromHypothesis(log.hypothesisId, index);
      const timestamp = new Date(log.timestamp).getTime();
      const dayKey = Math.floor(timestamp / (24 * 60 * 60 * 1000));
      this.removeIndexFromTimestamp(dayKey, index);
    }
  }
  
  private removeIndexFromHypothesis(hypothesisId: string, removedIndex: number): void {
    const indices = this.hypothesisIndex.get(hypothesisId);
    if (!indices) return;
    
    const filtered = indices
      .filter(idx => idx !== removedIndex)
      .map(idx => idx > removedIndex ? idx - 1 : idx);
    this.hypothesisIndex.set(hypothesisId, filtered);
  }
  
  private removeIndexFromTimestamp(dayKey: number, removedIndex: number): void {
    const indices = this.timestampIndex.get(dayKey);
    if (!indices) return;
    
    const filtered = indices
      .filter(idx => idx !== removedIndex)
      .map(idx => idx > removedIndex ? idx - 1 : idx);
    this.timestampIndex.set(dayKey, filtered);
  }
}
```

---

## üî• –ñ–µ—Å—Ç–∫–∞—è –∫—Ä–∏—Ç–∏–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #1: –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –æ–±—Ä–µ–∑–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –æ–±—Ä–µ–∑–∫–µ –Ω—É–∂–Ω–æ:
1. –ù–∞–π—Ç–∏ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å (O(n))
2. –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∏—Ö –∏–∑ –∫–∞–∂–¥–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –≤ hypothesisIndex (O(n*m), –≥–¥–µ m - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–∏–ø–æ—Ç–µ–∑)
3. –°–¥–≤–∏–Ω—É—Ç—å –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö (O(n*m))
4. –°–¥–µ–ª–∞—Ç—å —Ç–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è timestampIndex (O(n*k), –≥–¥–µ k - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π)

**–ò—Ç–æ–≥–æ:** O(n*m + n*k) –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –æ–±—Ä–µ–∑–∫–∏ vs O(n) –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ rebuildIndexes.

**–í—ã–≤–æ–¥:** –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å **–ú–ï–î–õ–ï–ù–ù–ï–ï**, —á–µ–º –ø–æ–ª–Ω—ã–π rebuild, –µ—Å–ª–∏ –≥–∏–ø–æ—Ç–µ–∑ –∏–ª–∏ –¥–Ω–µ–π –º–Ω–æ–≥–æ!

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #2: –£—Å–ª–æ–≤–∏–µ `removedCount > maxLogs / 2` –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Ä–æ–≥ 50% –≤—ã–±—Ä–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ. –†–µ–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –ø–µ—Ä–µ–ª–æ–º–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–∏–ø–æ—Ç–µ–∑ (m)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π (k)
- –†–∞–∑–º–µ—Ä–∞ –º–∞—Å—Å–∏–≤–æ–≤ –∏–Ω–¥–µ–∫—Å–æ–≤

**–í—ã–≤–æ–¥:** –ù—É–∂–Ω–æ —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º.

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #3: Race conditions –Ω–µ —Ä–µ—à–µ–Ω—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** `indexesValid` —Ñ–ª–∞–≥ –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `addLog()`:
- Thread 1: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `indexesValid = true`, –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å
- Thread 2: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `indexesValid = true`, –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å
- –û–±–∞ –¥–æ–±–∞–≤–ª—è—é—Ç –≤ –∏–Ω–¥–µ–∫—Å—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí –∏–Ω–¥–µ–∫—Å—ã –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏

**–í—ã–≤–æ–¥:** –ù—É–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (mutex) –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π.

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #4: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `removeIndexFromHypothesis` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞, –Ω–æ:
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ª–æ–≥ –∏–∑ —Å–µ—Ä–µ–¥–∏–Ω—ã –º–∞—Å—Å–∏–≤–∞, –Ω—É–∂–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å –í–°–ï –∏–Ω–¥–µ–∫—Å—ã –ø–æ—Å–ª–µ –Ω–µ–≥–æ
- –≠—Ç–æ O(n) –æ–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- –ü—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–∏—è—Ö —ç—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è O(n¬≤)

**–í—ã–≤–æ–¥:** –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–º.

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #5: –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** `indexesValid` —Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é, –Ω–æ –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:
- –ß—Ç–æ –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å—ã —Å—Ç–∞–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –∏–∑-–∑–∞ –±–∞–≥–∞?
- –ß—Ç–æ –µ—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –∏–∑–≤–Ω–µ?
- –ß—Ç–æ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤?

**–í—ã–≤–æ–¥:** –ù—É–∂–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–ª–∏ checksum.

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #6: –ü–∞–º—è—Ç—å
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–Ω–¥–µ–∫—Å—ã —Ö—Ä–∞–Ω—è—Ç –º–∞—Å—Å–∏–≤—ã –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –≥–∏–ø–æ—Ç–µ–∑—ã –∏ –¥–Ω—è. –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ª–æ–≥–æ–≤ —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏:
- 1000 –ª–æ–≥–æ–≤, 10 –≥–∏–ø–æ—Ç–µ–∑, 30 –¥–Ω–µ–π = ~1000 * 2 * 4 bytes = 8KB (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- –ù–æ –ø—Ä–∏ 10000 –ª–æ–≥–æ–≤ —ç—Ç–æ —É–∂–µ 80KB —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–Ω–¥–µ–∫—Å—ã

**–í—ã–≤–æ–¥:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ —Å—Ç–æ–∏—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å.

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏–∫–∏)

### –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ—Å—Ç–æ–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ–µ

**–ö–ª—é—á–µ–≤–æ–π –∏–Ω—Å–∞–π—Ç:** –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ —Å–ª–æ–∂–Ω–µ–µ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø–æ–ª–Ω–æ–≥–æ rebuild. –†–µ–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è - **–∏–∑–±–µ–≥–∞—Ç—å —á–∞—Å—Ç—ã—Ö –æ–±—Ä–µ–∑–æ–∫**.

```typescript
class SharedLogStorage {
  async addLog(log: RuntimeLog): Promise<void> {
    await this.loadFromFile();
    
    const index = this.logs.length;
    this.logs.push(log);
    
    // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—É–∂–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ O(1))
    this.updateIndexesForLog(log, index, 'add');
    
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï: –û–±—Ä–µ–∑–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
    const maxLogs = this.getMaxLogs();
    const trimThreshold = maxLogs * 1.2; // –û–±—Ä–µ–∑–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ 20% –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
    
    if (this.logs.length > trimThreshold) {
      // –û–±—Ä–µ–∑–∞–µ–º –¥–æ maxLogs
      this.logs = this.logs.slice(-maxLogs);
      // –ü–æ–ª–Ω—ã–π rebuild - –æ–Ω –±—ã—Å—Ç—Ä—ã–π (O(n)) –∏ –Ω–∞–¥–µ–∂–Ω—ã–π
      this.rebuildIndexes();
    }
    
    await this.saveToFile(this.logs);
    this.emit('logAdded', log);
  }
  
  // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
  private updateIndexesForLog(log: RuntimeLog, index: number): void {
    // Hypothesis index
    if (!this.hypothesisIndex.has(log.hypothesisId)) {
      this.hypothesisIndex.set(log.hypothesisId, []);
    }
    this.hypothesisIndex.get(log.hypothesisId)!.push(index);
    
    // Timestamp index
    const timestamp = new Date(log.timestamp).getTime();
    const dayKey = Math.floor(timestamp / (24 * 60 * 60 * 1000));
    if (!this.timestampIndex.has(dayKey)) {
      this.timestampIndex.set(dayKey, []);
    }
    this.timestampIndex.get(dayKey)!.push(index);
  }
  
  // –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π
  private operationQueue: Promise<void> = Promise.resolve();
  
  async addLog(log: RuntimeLog): Promise<void> {
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π
    this.operationQueue = this.operationQueue.then(async () => {
      await this.loadFromFile();
      // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
    });
    
    return this.operationQueue;
  }
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ:

1. ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ—Ç —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –æ–±—Ä–µ–∑–∫–∏
2. ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ü–æ–ª–Ω—ã–π rebuild –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤
3. ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –û–±—Ä–µ–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–∂–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ 20% –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏)
4. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç race conditions:** –û—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
5. ‚úÖ **–õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:** –ú–µ–Ω—å—à–µ edge cases

### –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:

- **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞:** O(1) - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–û–±—Ä–µ–∑–∫–∞:** O(n) - –Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ 5 —Ä–∞–∑ —Ä–µ–∂–µ (–ø—Ä–∏ 1200 –ª–æ–≥–∞—Ö –≤–º–µ—Å—Ç–æ 1001)
- **–û–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 80% –∑–∞ —Å—á–µ—Ç —Ä–µ–¥–∫–∏—Ö –æ–±—Ä–µ–∑–æ–∫

---

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω –¥–ª—è IMPROVEMENT_PLAN.md

### 1.1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ SharedLogStorage

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ª–æ–≥–æ–≤ –æ–±—Ä–µ–∑–∫–∞ —á–µ—Ä–µ–∑ `rebuildIndexes()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ (–∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ maxLogs).

**–†–µ—à–µ–Ω–∏–µ:** 
1. –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ä–æ–≥ –æ–±—Ä–µ–∑–∫–∏ (–æ–±—Ä–µ–∑–∞—Ç—å –ø—Ä–∏ 120% –æ—Ç maxLogs –≤–º–µ—Å—Ç–æ 100%)
2. –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç race conditions
3. –û—Å—Ç–∞–≤–∏—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ (—É–∂–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `src/shared-log-storage.ts`

**–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π
private operationQueue: Promise<void> = Promise.resolve();

// –ò–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –æ–±—Ä–µ–∑–∫–∏
const trimThreshold = maxLogs * 1.2; // –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–∏ 20% –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
if (this.logs.length > trimThreshold) {
  this.logs = this.logs.slice(-maxLogs);
  this.rebuildIndexes(); // –ü–æ–ª–Ω—ã–π rebuild - –±—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –æ–±—Ä–µ–∑–æ–∫ –Ω–∞ 80%, –æ–±—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 15-20%.
